# name: CI/CD - Build and Deploy to VPS

# on:
#   push:
#     branches: [ main ]

# jobs:
#   build-and-deploy:
#     runs-on: ubuntu-latest

#     steps:
#       - name: Checkout repository
#         uses: actions/checkout@v4

#       - name: Set up QEMU
#         uses: docker/setup-qemu-action@v2

#       - name: Set up Docker Buildx
#         uses: docker/setup-buildx-action@v2

#       - name: Build image and load into local Docker
#         uses: docker/build-push-action@v4
#         with:
#           context: .
#           push: false
#           load: true
#           tags: ${{ github.repository_owner }}/${{ github.repository }}:latest

#       - name: Save image to tar
#         run: |
#           docker image ls --format "{{.Repository}}:{{.Tag}}" | grep "${{ github.repository_owner }}/${{ github.repository }}:latest" || exit 1
#           docker save -o image.tar ${{ github.repository_owner }}/${{ github.repository }}:latest

#       - name: Copy image.tar to VPS
#         uses: appleboy/scp-action@master
#         with:
#           host: 161.97.91.40
#           username: ${{ secrets.VPS_SSH_USER }}
#           key: ${{ secrets.VPS_SSH_PRIVATE_KEY }}
#           port: 22
#           source: "image.tar"
#           target: "~/"

#       - name: Load image and run container on VPS
#         uses: appleboy/ssh-action@master
#         with:
#           host: 161.97.91.40
#           username: ${{ secrets.VPS_SSH_USER }}
#           key: ${{ secrets.VPS_SSH_PRIVATE_KEY }}
#           port: 22
#           script: |
#             set -e
#             if ! docker --version >/dev/null 2>&1; then
#               echo 'Docker not found, trying sudo';
#             fi
#             docker load -i ~/image.tar
#             docker rm -f webapp || true
#             docker run -d --name webapp -p 80:80 --restart=always ${{ github.repository_owner }}/${{ github.repository }}:latest
#             rm -f ~/image.tar
